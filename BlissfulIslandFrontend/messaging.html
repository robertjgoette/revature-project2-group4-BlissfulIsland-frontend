<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://use.typekit.net/jyg2wba.css">
    <link href="css/style.css" rel="stylesheet"/>
    <link rel="icon" type="image/png" href="CSS/Logo-s.png"/>
    <title>Home Page</title>
</head>
<body>
    <header id="navBar" class="navBar">
        <div class="navBar__logo">
            <img id="logoM" class="navBar__img" src="CSS/Logo-M.png" alt="Logo">
            <!-- <img id="logoS" class="hidden" src="CSS/Logo-s.png" alt=""> -->
        </div>
        <div id="navBarGroup" class="navBar__group">
            <div id="sendMessage"class = "navBar__group__links"><!--JS fill if account account on messaging--></div>
            <div id="accountMaker" class = "navBar__group__links"><!--JS fill if account is manager--></div>
            <div id="unitList"class = "navBar__group__links"><!--JS fill if account is manager--></div>
            <div class = "navBar__group__links">
                <a id="logOut" onclick="logOut()">Log Out</a>
            </div>
        </div>
    </header>
    <div class="plusBox">
        <h3 id="recentMessagesHead">Recent Messages</h3>
    </div>
    <div id="recentMessage" class="tables">
        <table id="recentMessageTable" class="tables__message">
            <thead id="recentMessageTableHead"></thead>
            <tbody id="recentMessageTableBody"></tbody>
        </table>
    </div>

    <div class="plusBox" onclick="flipPlus()">
        <h3 id="oldMessagesHead">Old Messages</h3>
        <div class="plus__btn">
            <span id="oldPlus" class="plus"></span>
        </div>
    </div>
    <div id="oldMessages"class="tables inactive">
        <table id="oldMessagesTable" class="tables__message">
            <thead id="oldMessagesTableHead"></thead>
            <tbody id="oldMessagesTableBody"></tbody>
        </table>
    </div>

    <div id="popUp" class="popUp">
        <div class="popUp__content">
            <span onclick="closePopUp()"id = "close" class="popUp__close">X</span>
            <h3 id="popUpContentHeader"></h3>
            <label for="messageBody">Message</label><br>
            <textarea class="messageBox" id="messageText" name="messageBody" maxlength = "200"></textarea><br>
            <div id ="issue"></div>
            <div id="messageSubmit"></div>
        </div>
    </div>

</body>

<script>
    let namesAreSet = false;

    async function setNames(){
        const response = await fetch("http://localhost:7000/accounts");
        const responseJSON = await response.json();
        for(let i = 0; i < responseJSON.length; i++){
            element = responseJSON[i];
            let name = element.firstName + " " + element.lastName;
            nameCache.set(parseInt(element.accountID), name);
        }
        namesAreSet = true;
    }

    async function settingNames(){
        await setNames();
    }

    settingNames();

    const accountType = localStorage.getItem("accountType");
    const accountId = localStorage.getItem("accountID"); 
    const accountMaker = document.getElementById("accountMaker");
    const unitList = document.getElementById("unitList");
    const navBarGroup = document.getElementById("navBarGroup");
    const navBar = document.getElementById("navBar");
    const message = document.getElementById("message");

    const sendMessage = document.getElementById("sendMessage");
    const recentMessageTableHead = document.getElementById("recentMessageTableHead");
    const oldMessagesTableHead = document.getElementById("oldMessagesTableHead");
    const recentMessageTableBody = document.getElementById("recentMessageTableBody");
    const oldMessagesTableBody = document.getElementById("oldMessagesTableBody");
    const oldMessages = document.getElementById("oldMessages");
    const recentMessagesHead = document.getElementById("recentMessagesHead");
    const oldMessagesHead = document.getElementById("oldMessagesHead");
    const logoM = document.getElementById("logoM");

    const popUp = document.getElementById("popUp");
    const close = document.getElementById("close");
    const popUpContentHeader = document.getElementById("popUpContentHeader");
    const messageBody = document.getElementById("messageBody");
    const messageSubmit = document.getElementById("messageSubmit");
    const issue = document.getElementById("issue");

    const nameCache = new Map();
    

    // Start of run on load up
    if(accountType == 1){
        getAllMessage();
    }else{
        getAllMessageForTent();
    }
    
    // End of run on load up

    // Start of Table interations
    function flipPlus(){
        oldPlus.classList.toggle("plus--acitve")
        if (oldMessages.style.maxHeight){
            oldMessages.style.maxHeight = null;
        } else {
            oldMessages.style.maxHeight = oldMessages.scrollHeight + "px";
        }
    }
    // End of table interation

    // Start of message fetching
    async function getAllMessage(){
        const response = await fetch("http://localhost:7000/messages");
        let messageTable = await response.json();
        messageTable.sort(function(x, y) {
            return parseFloat(y.timeSent) - parseFloat(x.timeSent);
        });
        recentMessageTableFill = "";
        oldMessageTableFill = "";
        let messageTableHeadFill = "<th>Time Sent</th><th>Who Sent it</th><th>Message</th><th>Respond</th>";
        i = 0
        messageTable.map(message => messageSorting(message))

        recentMessageTableHead.innerHTML = messageTableHeadFill;
        oldMessagesTableHead.innerHTML = messageTableHeadFill;
        recentMessageTableBody.innerHTML = recentMessageTableFill;
        oldMessagesTableBody.innerHTML = oldMessageTableFill;

        names();
    }

    async function getAllMessageForTent(){
        let sendMessageButton = "<a id='sendMessageButton' onclick=popUpMessageTent()>Send Message</a>";
        sendMessage.innerHTML = sendMessageButton;

        const response = await fetch("http://localhost:7000/messages");
        let messageTable = await response.json();
        messageTable.sort(function(x, y) {
            return parseFloat(y.timeSent) - parseFloat(x.timeSent);
        });
        recentMessageTableFill = "";
        oldMessageTableFill = "";
        i = 0
        messageTable.map(message => messageSorting(message))
        const recentMessagesHead = document.getElementById("recentMessagesHead");
        const oldMessagesHead = document.getElementById("oldMessagesHead");
        let messageTableHeadFill = "<th>Time Sent</th><th>Who Sent it</th><th>Message</th>";
        recentMessageTableHead.innerHTML = messageTableHeadFill;
        oldMessagesTableHead.innerHTML = messageTableHeadFill;
        recentMessageTableBody.innerHTML = recentMessageTableFill;
        oldMessagesTableBody.innerHTML = oldMessageTableFill;

        names();
    }

    async function names(){
        for(let x = 0; x < i; x++){
            const name = document.getElementById(`name${x}`);
            if(name !== null){
                let id = name.innerHTML;
                name.innerHTML = await getName(parseInt(id));
            }
        }
    }

    function messageSorting(message){
        if(accountType == 1){
            if(i <= 2 ){ 
                recentMessageTableFill += `<tr> 
                <td>${unixToDate(message.timeSent)}</td>
                <!-- <td>${message.senderID}</td> -->
                <td id="name${i}">${message.senderID}</td>
                <td>${message.messageBody}</td>
                <td><a id="respond${message.messageID}" class="respond" onclick = respondPopUp(${message.senderID})>Respond</a>
                </tr>`
            } else{
                oldMessageTableFill += `<tr> 
                <td>${unixToDate(message.timeSent)}</td>
                <!-- <td>${message.senderID}</td> -->
                <td id="name${i}">${message.senderID}</td>
                <td>${message.messageBody}</td>
                <td><a id="respond${message.messageID}" class="respond" onclick = respondPopUp(${message.senderID})>Respond</a>
                </tr>`
            }
        }
        else if (message.senderID == accountId || message.receiverID == accountId){
            if(i <= 2 ){ 
            recentMessageTableFill += `<tr> 
                <td>${unixToDate(message.timeSent)}</td>
                <!-- <td>${message.senderID}</td> -->
                <td id="name${i}">${message.senderID}</td>
                <td>${message.messageBody}</td>
                </tr>`
            } else{
                oldMessageTableFill += `<tr> 
                <td>${unixToDate(message.timeSent)}</td>
                <!-- <td>${message.senderID}</td> -->
                <td id="name${i}">${message.senderID}</td>
                <td>${message.messageBody}</td>
                </tr>`
            }
        }
        i++
    }

    function unixToDate(timestamp){
        let fullTime = new Date(timestamp);
        let months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        let year = fullTime.getFullYear();
        let month = months[fullTime.getMonth()];
        let date = fullTime.getDate();
        let time = date + ' ' + month + ' ' + year;
        return time;
    }

    async function getName(id){
        if(namesAreSet === false){
            await new Promise(r => setTimeout(r, 50));
        }
        return nameCache.get(id);
    }
    // End of message fetching

    // Start of message popUp
    function popUpMessageTent(){
        popUp.style.display = "block";
        let popUpContentHeaderFill = `What seems to be the issue?`;
        let approveButton=`<button id='messageSubmit' class='tenantSubmitBtn' onclick = sendMessageTent()>Send</button>`;
        let issues = "<label for='typeOfIssue'>Issue</label><br><select name='typeOfIssue' id='typeOfIssue'><option value='null' disabled selected>Choose Type</option><option value='0'>Question</option><option value='1'>Utility</option></select>"
        issue.innerHTML = issues;
        popUpContentHeader.innerHTML = popUpContentHeaderFill;
        messageSubmit.innerHTML = approveButton;
    }
    function respondPopUp(id){
        popUp.style.display = "block";
        let popUpContentHeaderFill = `How would you like to respond?`;
        let approveButton=`<button id='responseSubmit' onclick = sendResponse(${id})>Send</button>`;
        popUpContentHeader.innerHTML = popUpContentHeaderFill;
        messageSubmit.innerHTML = approveButton;
    }  
    function closePopUp(){
        messageText.value ="";
        popUp.style.display = "none";
    }
    window.onclick = function(event) {
        if (event.target == popUp) {
            closePopUp();
        }
    }
    // End of message popUp

    //Start of message sending
    async function sendMessageTent(){
        const btn = document.querySelector(".tenantSubmitBtn");
        btn.disabled = true;
        if(typeOfIssue.value === "null"){
            btn.disabled = false;
            alert("Please select a type for your message")
        }
        else{
            const message = {
                "senderID":accountId,
                "receiverID": 1,
                "messageBody": messageText.value,
                "timeSent": 0,
                "messageType": typeOfIssue.value};
                const typeOfMethod ={
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(message)
                };
                messageText.value ="";
                let url = `http://localhost:7000/messages`
                const putReimbursement = await fetch(url, typeOfMethod);
                getAllMessageForTent();
                closePopUp();
            }
    }
    async function sendResponse(id){
        const btn = document.getElementById("responseSubmit");
        btn.disabled = true;
        const message = {
            "senderID":accountId,
            "receiverID": id,
            "messageBody": messageText.value,
            "timeSent": 0,
            "messageType": 0};
        const typeOfMethod ={
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(message)
        };
        messageText.value ="";
        let url = `http://localhost:7000/messages`
        const putReimbursement = await fetch(url, typeOfMethod);
        getAllMessage();
        closePopUp();
    }
    // end of message sending
    
    /*Application state and redirects*/

</script>
<script src="JS/index.js"></script>
</html>